<!DOCTYPE html>
<title>Chat demo</title>
<style>
body{
  background:#ccc;
  color:#000;
  font:.8125em/1.231em arial,sans-serif;
}
body,fieldset,form,h1,h2,h3,h4,input,li,ol,p,td,textarea,th{
  margin:0;
  padding:0
}
ul{
  margin:0 normal
}
table{
  border-collapse:collapse
}
fieldset,img{
  border:0
}
h1,h2,h3,h4,input,select,textarea,th{
  font:1em f;
  line-height:inherit;
  font-family:inherit
}
a{
  color:#11c;
  white-space:nowrap;
}
a:visited{
  color:#551a8b
}
a:active{
  color:#c11
}
img[src="data:,"]{
  visibility:hidden
}

li{
  padding-top:8px;
  clear:both;
}
#messageList{
  list-style:none;
  padding:0 0 65px;
  margin:0;
}
.message,#inputs{
  margin:0 8px 0 66px
}
.message{
  background:#b7e0ff;
  border:3px solid #fff;
  border-radius:8px;
  padding:4px 6px;
}
.pic{
  width:50px;
  height:50px;
  float:left;
  margin:0 8px;
}
#foot{
  background:inherit;
  width:100%;
  border-top:1px solid #666 ;
  position:fixed;
  bottom:0;
  padding:8px 0;
}
input{
  padding:1px;
}
</style>
<script src=extern.js></script>
<script src=socket.io/socket.io.js></script>
<script>
var socket = new io.Socket(null, {port: 8001});
socket.connect();

var User = function(init) {
  this.name = new Val(init['name'] || '');
  this.picUrl = new Val(init['picUrl'] || '');
}
var Message = function(init) {
  this.user = init['user'] || new User();
  this.comment = new Val(init['comment'] || '');
}

var users = [
      new User({
        name: 'Nate',
        picUrl: 'http://nateps.com/resume/nate_smith_92x92.jpg'
      })
    ],
    session = {
      user: users[0],
      newComment: new Val('')
    },
    messages = new List;

function outMessage(message) {
  var picId = uniqueId(),
      nameId = uniqueId(),
      commentId = uniqueId();
  addAttributeUpdater(picId, 'src', message.user.picUrl);
  addInnerUpdater(nameId, message.user.name);
  addInnerUpdater(commentId, message.comment);
  
  return '<li> \
    <img id=' + picId + ' src="' + message.user.picUrl.get() + '" class=pic> \
    <div class=message> \
      <p><b id=' + nameId + '>' + message.user.name.get() + '</b> \
      <p id=' + commentId + '>' + message.comment.get() + '</div>'
}

function outBody() {
  addListUpdater('messageList', outMessage, messages);
  addAttributeUpdater('inputPic', 'src', session.user.picUrl);
  addAttributeUpdater('inputName', 'value', session.user.name);
  addPropertyUpdater('commentInput', 'value', session.newComment);
  
  return '<ul id=messageList>' + outList(outMessage, messages) + '</ul> \
    <div id=foot> \
      <img id=inputPic src="' + session.user.picUrl.get() + '" class=pic> \
      <div id=inputs> \
        <input id=inputName onkeyup=session.user.name.set(this.value) value="' + session.user.name.get() + '"> <b>(your nickname)</b> \
        <form action=javascript:postMessage() style=position:relative;margin-top:6px;padding-right:6px> \
          <input id=commentInput style=width:100% onkeyup=session.newComment.setSilent(this.value) value="' + session.newComment.get() + '"> \
        </form> \
      </div> \
    </div>'
}

function postMessage() {
  messages.push(
    new Message({
      user: session.user,
      comment: session.newComment.get()
    })
  );
  session.newComment.set('');
}

document.write(outBody());
document.getElementById('commentInput').focus();
</script>